"use strict";(self["webpackChunkweather_project_vue3"]=self["webpackChunkweather_project_vue3"]||[]).push([[163],{9140:function(t,e,s){s.r(e),s.d(e,{default:function(){return f}});var n=s(6768),i=s(4232);const a={ref:"canvas"};function o(t,e,s,o,r,h){return(0,n.uX)(),(0,n.CE)(n.FK,null,[(0,n.Lk)("h1",null,"Карта "+(0,i.v_)(t.layerTitle),1),(0,n.Lk)("div",{class:"map-wrap",onMousedown:e[0]||(e[0]=(...e)=>t.startDrag&&t.startDrag(...e)),onMousemove:e[1]||(e[1]=(...e)=>t.onDrag&&t.onDrag(...e)),onMouseup:e[2]||(e[2]=(...e)=>t.endDrag&&t.endDrag(...e)),onMouseleave:e[3]||(e[3]=(...e)=>t.onMouseLeave&&t.onMouseLeave(...e)),onTouchstart:e[4]||(e[4]=(...e)=>t.startDrag&&t.startDrag(...e)),onTouchmove:e[5]||(e[5]=(...e)=>t.onDrag&&t.onDrag(...e)),onTouchend:e[6]||(e[6]=(...e)=>t.endDrag&&t.endDrag(...e)),onTouchcancel:e[7]||(e[7]=(...e)=>t.onTouchCancel&&t.onTouchCancel(...e))},[(0,n.Lk)("canvas",a,null,512)],32),e[8]||(e[8]=(0,n.Lk)("div",{class:"map-caption"},[(0,n.Lk)("span",null,"Источник карты мира: OpenStreetMap.org")],-1))],64)}function r(t,e){let s,n=!0;return function(...i){const a=this;n&&(n=!1,t.apply(a,i),s=setTimeout(()=>{n=!0},e))}}var h=(0,n.pM)({name:"Map",data(){return{apiKey:"36b59a428ae07106b683317f19604659",layer:"precipitation_new",z:3,tileSize:256,cacheTTL:18e5,isDragging:!1,offsetX:0,offsetY:0,lastX:0,lastY:0,updateTimer:null}},methods:{async renderMap(){const{z:t,layer:e,apiKey:s,tileSize:n}=this,i=Math.pow(2,t),a=this.$refs.canvas;if(!a)return;const o=a.getContext("2d");if(o){a.width=n*i,a.height=n*i,console.log(`Рисуем карту: z=${t}, тайлов=${i**2}`);for(let e=0;e<i;e++)for(let s=0;s<i;s++){const n=`https://tile.openstreetmap.org/${t}/${e}/${s}.png`;await this.drawTile(o,n,e,s)}for(let n=0;n<i;n++)for(let a=0;a<i;a++){const i=`https://tile.openweathermap.org/map/${e}/${t}/${n}/${a}.png?appid=${s}`;await this.drawTile(o,i,n,a)}console.log("Карта готова")}},async drawTile(t,e,s,n){return new Promise((i,a)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{t.globalAlpha=1,t.drawImage(o,s*this.tileSize,n*this.tileSize),t.globalAlpha=1,i()},o.onerror=a,o.src=e})},startDrag(t){this.isDragging=!0;const e=t instanceof TouchEvent?t.touches[0]:t;this.lastX=e.clientX,this.lastY=e.clientY},onDrag(t){if(!this.isDragging)return;const e=t instanceof TouchEvent?t.touches[0]:t,s=e.clientX-this.lastX,n=e.clientY-this.lastY;this.lastX=e.clientX,this.lastY=e.clientY,this.offsetX+=s,this.offsetY+=n;const i=this.$refs.canvas,a=i.parentElement,o=i.clientWidth,r=i.clientHeight,h=a.clientWidth,l=a.clientHeight,c=0,f=h-o,u=0,p=l-r;this.offsetX<f?this.offsetX=f:this.offsetX>c&&(this.offsetX=c),this.offsetY<p?this.offsetY=p:this.offsetY>u&&(this.offsetY=u),i.style.transform=`translate(${this.offsetX}px, ${this.offsetY}px)`},endDrag(){this.isDragging=!1},onResize(){const t=this.$refs.canvas,e=t.parentElement,s=t.clientWidth,n=t.clientHeight,i=e.clientWidth,a=e.clientHeight,o=0,r=i-s,h=0,l=a-n;this.offsetX<r&&(this.offsetX=r),this.offsetX>o&&(this.offsetX=o),this.offsetY<l&&(this.offsetY=l),this.offsetY>h&&(this.offsetY=h),t.style.transform=`translate(${this.offsetX}px, ${this.offsetY}px)`},onMouseLeave(){this.isDragging&&this.endDrag()},onTouchCancel(){this.onMouseLeave()},startAutoUpdate(){this.updateTimer||(this.updateTimer=window.setInterval(()=>{console.log("Автоматическое обновление карты"),this.renderMap()},this.cacheTTL))},stopAutoUpdate(){this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=null)}},mounted(){this.renderMap(),this.onDrag=r(this.onDrag,50),this.startAutoUpdate(),this.onResize=r(this.onResize,50),window.addEventListener("resize",this.onResize)},activated(){window.removeEventListener("resize",this.onResize),this.startAutoUpdate()},deactivated(){window.addEventListener("resize",this.onResize),this.stopAutoUpdate()},computed:{layerTitle(){switch(this.layer){case"precipitation_new":return"осадков";case"clouds_new":return"облаков";case"pressure_new":return"давления на уровне моря";case"wind_new":return"скорости ветра";case"temp_new":return"температуры";default:return""}}}}),l=s(1241);const c=(0,l.A)(h,[["render",o],["__scopeId","data-v-2723b778"]]);var f=c}}]);
//# sourceMappingURL=map.ef5d72bf.js.map