"use strict";(self["webpackChunkweather_project_vue3"]=self["webpackChunkweather_project_vue3"]||[]).push([[163],{9932:function(t,e,s){s.r(e),s.d(e,{default:function(){return u}});var a=s(6768),n=s(4232);const i={ref:"canvas"};function o(t,e,s,o,r,c){return(0,a.uX)(),(0,a.CE)(a.FK,null,[(0,a.Lk)("h1",null,"Карта "+(0,n.v_)(t.layerTitle),1),(0,a.Lk)("div",{class:"map-wrap",onMousedown:e[0]||(e[0]=(...e)=>t.startDrag&&t.startDrag(...e)),onMousemove:e[1]||(e[1]=(...e)=>t.onDrag&&t.onDrag(...e)),onMouseup:e[2]||(e[2]=(...e)=>t.endDrag&&t.endDrag(...e)),onMouseleave:e[3]||(e[3]=(...e)=>t.onMouseLeave&&t.onMouseLeave(...e)),onTouchstart:e[4]||(e[4]=(...e)=>t.startDrag&&t.startDrag(...e)),onTouchmove:e[5]||(e[5]=(...e)=>t.onDrag&&t.onDrag(...e)),onTouchend:e[6]||(e[6]=(...e)=>t.endDrag&&t.endDrag(...e)),onTouchcancel:e[7]||(e[7]=(...e)=>t.onTouchCancel&&t.onTouchCancel(...e))},[(0,a.Lk)("canvas",i,null,512)],32),e[8]||(e[8]=(0,a.Lk)("div",{class:"map-caption"},[(0,a.Lk)("span",null,"Источник карты мира: OpenStreetMap.org")],-1))],64)}function r(t,e){let s,a=!0;return function(...n){const i=this;a&&(a=!1,t.apply(i,n),s=setTimeout(()=>{a=!0},e))}}var c=(0,a.pM)({name:"Map",data(){return{apiKey:"36b59a428ae07106b683317f19604659",layer:"precipitation_new",z:3,tileSize:256,cacheTTL:18e5,isDragging:!1,offsetX:0,offsetY:0,lastX:0,lastY:0,updateTimer:null}},methods:{async renderMap(){const{z:t,layer:e,apiKey:s,tileSize:a}=this,n=Math.pow(2,t),i=this.$refs.canvas;if(!i)return;const o=i.getContext("2d");if(o){i.width=a*n,i.height=a*n,console.log(`Рисуем карту: z=${t}, тайлов=${n**2}`);for(let e=0;e<n;e++)for(let s=0;s<n;s++){const a=`https://tile.openstreetmap.org/${t}/${e}/${s}.png`;await this.drawTile(o,a,e,s)}for(let a=0;a<n;a++)for(let i=0;i<n;i++){const n=`https://tile.openweathermap.org/map/${e}/${t}/${a}/${i}.png?appid=${s}`;await this.drawTile(o,n,a,i)}console.log("Карта готова")}},async drawTile(t,e,s,a){return new Promise((n,i)=>{const o=new Image;o.crossOrigin="anonymous",o.onload=()=>{t.globalAlpha=1,t.drawImage(o,s*this.tileSize,a*this.tileSize),t.globalAlpha=1,n()},o.onerror=i,o.src=e})},startDrag(t){this.isDragging=!0;const e=t instanceof TouchEvent?t.touches[0]:t;this.lastX=e.clientX,this.lastY=e.clientY},onDrag(t){if(!this.isDragging)return;const e=t instanceof TouchEvent?t.touches[0]:t,s=e.clientX-this.lastX,a=e.clientY-this.lastY;this.lastX=e.clientX,this.lastY=e.clientY,this.offsetX+=s,this.offsetY+=a;const n=this.$refs.canvas,i=n.parentElement,o=n.clientWidth,r=n.clientHeight,c=i.clientWidth,l=i.clientHeight,h=0,u=c-o,p=0,f=l-r;this.offsetX<u?this.offsetX=u:this.offsetX>h&&(this.offsetX=h),this.offsetY<f?this.offsetY=f:this.offsetY>p&&(this.offsetY=p),n.style.transform=`translate(${this.offsetX}px, ${this.offsetY}px)`},endDrag(){this.isDragging=!1},onMouseLeave(){this.isDragging&&this.endDrag()},onTouchCancel(){this.onMouseLeave()},startAutoUpdate(){this.updateTimer||(this.updateTimer=window.setInterval(()=>{console.log("Автоматическое обновление карты"),this.renderMap()},this.cacheTTL))},stopAutoUpdate(){this.updateTimer&&(clearInterval(this.updateTimer),this.updateTimer=null)}},mounted(){this.renderMap(),this.onDrag=r(this.onDrag,50),this.startAutoUpdate()},activated(){this.startAutoUpdate()},deactivated(){this.stopAutoUpdate()},computed:{layerTitle(){switch(this.layer){case"precipitation_new":return"осадков";case"clouds_new":return"облаков";case"pressure_new":return"давления на уровне моря";case"wind_new":return"скорости ветра";case"temp_new":return"температуры";default:return""}}}}),l=s(1241);const h=(0,l.A)(c,[["render",o],["__scopeId","data-v-9b1c9cc4"]]);var u=h}}]);
//# sourceMappingURL=map.e862981d.js.map